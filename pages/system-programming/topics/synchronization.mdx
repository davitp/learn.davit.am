---
description: Understanding synchronization problems in concurrent programming. Introduction to race conditions, critical sections, and main synchronization primitives in POSIX systems.
---
# Synchronization and Critical Sections

## Overview
This week explores one of the most important challenges in multithreaded programming — **synchronization**.  
Students will understand how **race conditions** arise when multiple threads access shared data concurrently, and how to control access to critical sections using **synchronization primitives** such as mutexes, spinlocks, semaphores, condition variables, and atomic operations.

---

## Key Concepts

#### Concurrency and Race Conditions
- **Race condition:** when multiple threads access and modify shared data simultaneously, leading to unpredictable results.  
- **Critical section:** a segment of code that must not be executed by more than one thread at a time.  
- **Data consistency:** maintaining integrity of shared resources under concurrent access.

#### Synchronization Primitives
- **Mutex (Mutual Exclusion Lock):**  
  - Ensures only one thread executes a critical section at a time.  
  - Core functions: `pthread_mutex_init`, `pthread_mutex_lock`, `pthread_mutex_unlock`, `pthread_mutex_destroy`.  

- **Spinlock:**  
  - Lightweight lock that continuously checks availability without sleeping.  
  - Suitable for short critical sections on multicore systems.  

- **Semaphore:**  
  - A counter-based synchronization mechanism for controlling access to a finite number of resources.  
  - POSIX functions: `sem_init`, `sem_wait`, `sem_post`, `sem_destroy`.  

- **Condition Variable:**  
  - Used for signaling between threads.  
  - Allows a thread to wait until a certain condition becomes true.  
  - Core functions: `pthread_cond_wait`, `pthread_cond_signal`, `pthread_cond_broadcast`.  

- **Atomic Operations and CAS (Compare-And-Swap):**  
  - Low-level operations ensuring atomic updates without explicit locks.  
  - Foundation for lock-free synchronization structures.

#### Deadlocks and Starvation (Intro)
- Circular wait, hold and wait, no preemption, mutual exclusion — the four conditions for deadlock.
- Techniques to avoid or detect deadlocks will be discussed in future weeks.

---

## Practice
#### Demonstrating Race Conditions
- Create a shared counter updated by multiple threads without locks — observe inconsistent results.  
- Protect the counter using a mutex and verify correct output.

#### Working with Mutexes
- Use a mutex to protect a critical section in a multi-threaded program.  
- Experiment with `pthread_mutex_trylock` and `PTHREAD_MUTEX_RECURSIVE`.

#### Using Semaphores
- Implement a simple producer-consumer synchronization using semaphores.

#### Condition Variables
- Demonstrate thread signaling (one thread waits until another signals a condition).  
- Compare busy-waiting vs. condition-based waiting.

#### Spinlocks and Atomics
- Experiment with short critical sections using spinlocks.  
- Observe CPU utilization differences compared to mutexes.

---

### Homework
   - [TH-2: The thread pool implementation](/system-programming/tasks/threads/thread-pool/)

---

## References
**Required**
- [ECE 252 Lecture 12: Concurrency: Synchronization & Atomicity](https://www.youtube.com/watch?v=oehU_Jie3lI)
- [ECE 252 Lecture 13: Semaphores](https://www.youtube.com/watch?v=TF9q76lEwKI)
- [ECE 252 Lecture 14: Synchronization Patterns](https://www.youtube.com/watch?v=ru4Q55Jlf-Y)
- [Параллельное программирование. Лекция 2 Лекция](https://www.lektorium.tv/lecture/13560)
- [Mutex vs Semaphore](https://www.geeksforgeeks.org/mutex-vs-semaphore/)
- [Spinlocks - Part 1 - A Basic Spinlock ](https://www.youtube.com/watch?v=AN6XHy2znzc)
- [Compare-and-swap](https://en.wikipedia.org/wiki/Compare-and-swap)
- *Advanced Programming in the UNIX Environment* — W. Richard Stevens, Chapter 12 “Thread Synchronization”  
- *Programming with POSIX Threads* — David R. Butenhof, Chapters 4–6  
- *Operating Systems: Three Easy Pieces* — Chapters “Concurrency,” “Locks,” and “Condition Variables”  

**Recommended**
- [ECE 252 Lecture 16: The Readers-Writers Problem](https://www.youtube.com/watch?v=mB_CNguuiew)
- [ECE 252 Lecture 17: Deadlock](https://www.youtube.com/watch?v=y1iDjVuGPSk)
- [ECE 252 Lecture 18: Deadlock Avoidance](https://www.youtube.com/watch?v=QU8PK97SeQE)
- [ECE 252 Lecture 19: Deadlock Detection and Recovery](https://www.youtube.com/watch?v=vZPLbMFXOHU)
- [Mutex lock for Linux Thread Synchronization](https://www.geeksforgeeks.org/mutex-lock-for-linux-thread-synchronization/)
- [How to use Semaphores in POSIX Concurrency Control](https://packt.medium.com/how-to-use-semaphores-in-posix-concurrency-control-144c34549807)
- [Linux manual page - pthread_mutex_init(3p)](https://man7.org/linux/man-pages/man3/pthread_mutex_init.3p.html)
- [Linux manual page - pthread_mutex_destroy(3p)](https://man7.org/linux/man-pages/man3/pthread_mutex_destroy.3p.html)
- [Linux manual page - pthread_mutex_lock(3p)](https://man7.org/linux/man-pages/man3/pthread_mutex_lock.3p.html)
- [Linux manual page - pthread_mutex_unlock(3p)](https://man7.org/linux/man-pages/man3/pthread_mutex_unlock.3p.html)
- [Linux manual page - spin_lock(3)](https://man7.org/linux/man-pages/man3/pthread_spin_lock.3.html)
- [Linux manual page - spin_unlock(3)](https://man7.org/linux/man-pages/man3/pthread_spin_unlock.3.html)
- [Linux manual page - sem_init(3)](https://man7.org/linux/man-pages/man3/sem_init.3.html)
- [Linux manual page - sem_destroy(3p)](https://man7.org/linux/man-pages/man3/sem_destroy.3.html)
- [Linux manual page - sem_wait(3)](https://man7.org/linux/man-pages/man3/sem_wait.3.html)
- [Linux manual page - sem_post(3)](https://man7.org/linux/man-pages/man3/sem_post.3.html)
- [Linux manual page - pthread_cond_wait(3)](https://man7.org/linux/man-pages/man3/pthread_cond_wait.3p.html)
- [Linux manual page - pthread_cond_signal(3)](https://man7.org/linux/man-pages/man3/pthread_cond_signal.3p.html)

--- 

## Quiz (Self-Check)
1. What causes a race condition?  
2. What is the difference between a mutex and a spinlock?  
3. How does a semaphore differ from a mutex?  
4. What are the typical use cases for condition variables?  
5. What does “atomic operation” mean?  
6. Name the four necessary conditions for a deadlock.  
7. Why is it important to minimize the time spent inside a critical section?  
